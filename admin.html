<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Karigar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-tools"></i> Karigar
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="admin-panel.html">Admin Panel</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="handleLogout()">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="container">
            <h1 class="mb-2">Admin Panel</h1>
            <p class="mb-0">Manage platform users and services</p>
        </div>
    </div>

    <div class="container my-4">
        <!-- Stats -->
        <div class="dashboard-stats">
            <div class="stat-card">
                <h3 id="totalUsers">0</h3>
                <p>Total Users</p>
            </div>
            <div class="stat-card">
                <h3 id="totalProviders">0</h3>
                <p>Service Providers</p>
            </div>
            <div class="stat-card">
                <h3 id="pendingProviders">0</h3>
                <p>Pending Approvals</p>
            </div>
            <div class="stat-card">
                <h3 id="totalBookings">0</h3>
                <p>Total Bookings</p>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="providers-tab" data-bs-toggle="tab" data-bs-target="#providers" type="button">
                    Service Providers
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button">
                    All Users
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="bookings-tab" data-bs-toggle="tab" data-bs-target="#bookings" type="button">
                    Bookings
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button">
                    Reviews
                </button>
            </li>
        </ul>

        <div class="tab-content" id="adminTabContent">
            <!-- Service Providers Tab -->
            <div class="tab-pane fade show active" id="providers" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Service Provider Management</h5>
                    </div>
                    <div class="card-body">
                        <div id="providersList">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div class="tab-pane fade" id="users" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">All Users</h5>
                    </div>
                    <div class="card-body">
                        <div id="usersList">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bookings Tab -->
            <div class="tab-pane fade" id="bookings" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">All Bookings</h5>
                    </div>
                    <div class="card-body">
                        <div id="bookingsList">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reviews Tab -->
            <div class="tab-pane fade" id="reviews" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">All Reviews</h5>
                    </div>
                    <div class="card-body">
                        <div id="reviewsList">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/data.js"></script>
    <script src="js/utils.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (!utils.requireAuth('admin')) return;
            
            loadDashboard();
            
            // Reload when tab changes
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(e) {
                    const target = e.target.getAttribute('data-bs-target');
                    if (target === '#providers') loadProviders();
                    else if (target === '#users') loadUsers();
                    else if (target === '#bookings') loadBookings();
                    else if (target === '#reviews') loadReviews();
                });
            });
        });
        
        function loadDashboard() {
            const users = authManager.getAllUsers();
            const providers = dataManager.getServiceProviders();
            const bookings = dataManager.getBookings();
            
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('totalProviders').textContent = providers.length;
            document.getElementById('pendingProviders').textContent = providers.filter(p => p.status === 'pending').length;
            document.getElementById('totalBookings').textContent = bookings.length;
            
            loadProviders();
        }
        
        function loadProviders() {
            const providers = dataManager.getServiceProviders();
            const users = authManager.getAllUsers();
            const providersList = document.getElementById('providersList');
            
            if (providers.length === 0) {
                providersList.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-person-x"></i>
                        <h5>No service providers</h5>
                    </div>
                `;
                return;
            }
            
            providersList.innerHTML = providers.map(provider => {
                const user = users.find(u => u.id === provider.userId);
                const statusBadge = provider.status === 'approved' 
                    ? '<span class="badge bg-success">Approved</span>'
                    : '<span class="badge bg-warning">Pending</span>';
                
                return `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="card-title">${provider.businessName}</h5>
                                    <p class="text-muted mb-2">
                                        <i class="bi bi-person"></i> ${user?.name || 'Unknown'}<br>
                                        <i class="bi bi-tag"></i> ${provider.category}<br>
                                        <i class="bi bi-geo-alt"></i> ${provider.location}<br>
                                        <i class="bi bi-star"></i> ${provider.rating} (${provider.totalReviews} reviews)
                                    </p>
                                    <p>${provider.description}</p>
                                    ${statusBadge}
                                </div>
                                <div>
                                    ${provider.status === 'pending' ? `
                                        <button class="btn btn-sm btn-success me-2" onclick="approveProvider('${provider.id}')">
                                            Approve
                                        </button>
                                    ` : ''}
                                    <button class="btn btn-sm btn-danger" onclick="suspendProvider('${provider.id}')">
                                        ${provider.status === 'approved' ? 'Suspend' : 'Delete'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function loadUsers() {
            const users = authManager.getAllUsers();
            const usersList = document.getElementById('usersList');
            
            if (users.length === 0) {
                usersList.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-people"></i>
                        <h5>No users</h5>
                    </div>
                `;
                return;
            }
            
            usersList.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Location</th>
                                <th>Joined</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => `
                                <tr>
                                    <td>${user.name}</td>
                                    <td>${user.email}</td>
                                    <td><span class="badge bg-primary">${user.role}</span></td>
                                    <td>${user.location || 'N/A'}</td>
                                    <td>${utils.formatDate(user.createdAt)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function loadBookings() {
            const bookings = dataManager.getBookings();
            const users = authManager.getAllUsers();
            const providers = dataManager.getServiceProviders();
            const bookingsList = document.getElementById('bookingsList');
            
            if (bookings.length === 0) {
                bookingsList.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-calendar-x"></i>
                        <h5>No bookings</h5>
                    </div>
                `;
                return;
            }
            
            bookings.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            bookingsList.innerHTML = bookings.map(booking => {
                const customer = users.find(u => u.id === booking.customerId);
                const provider = providers.find(p => p.id === booking.providerId);
                const statusClass = `status-${booking.status}`;
                
                return `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6>${booking.service}</h6>
                            <p class="text-muted mb-2">
                                <i class="bi bi-person"></i> Customer: ${customer?.name || 'Unknown'}<br>
                                <i class="bi bi-tools"></i> Provider: ${provider?.businessName || 'Unknown'}<br>
                                <i class="bi bi-calendar"></i> ${utils.formatDate(booking.date)}<br>
                                <i class="bi bi-clock"></i> ${booking.timeSlot}<br>
                                <i class="bi bi-currency-rupee"></i> ${booking.price}
                            </p>
                            <span class="badge status-badge ${statusClass}">${booking.status.toUpperCase()}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function loadReviews() {
            const reviews = dataManager.getReviews();
            const providers = dataManager.getServiceProviders();
            const reviewsList = document.getElementById('reviewsList');
            
            if (reviews.length === 0) {
                reviewsList.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-chat-left"></i>
                        <h5>No reviews</h5>
                    </div>
                `;
                return;
            }
            
            reviews.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            reviewsList.innerHTML = reviews.map(review => {
                const provider = providers.find(p => p.id === review.providerId);
                const stars = utils.generateStars(review.rating);
                
                return `
                    <div class="card mb-3 review-card">
                        <div class="card-body">
                            <div class="review-header">
                                <div>
                                    <h6>${review.customerName}</h6>
                                    <p class="text-muted mb-1">${provider?.businessName || 'Unknown Provider'}</p>
                                </div>
                                <div class="text-end">
                                    <div class="rating">${stars}</div>
                                    <small class="text-muted">${utils.formatDate(review.createdAt)}</small>
                                </div>
                            </div>
                            <p class="mb-0">${review.text}</p>
                            <button class="btn btn-sm btn-danger mt-2" onclick="deleteReview('${review.id}')">
                                Delete Review
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function approveProvider(providerId) {
            const provider = dataManager.getServiceProviderById(providerId);
            if (provider) {
                provider.status = 'approved';
                dataManager.saveServiceProvider(provider);
                utils.showAlert('Provider approved successfully!', 'success');
                loadProviders();
                loadDashboard();
            }
        }
        
        function suspendProvider(providerId) {
            if (confirm('Are you sure you want to suspend/delete this provider?')) {
                const providers = dataManager.getServiceProviders();
                const filtered = providers.filter(p => p.id !== providerId);
                localStorage.setItem('serviceProviders', JSON.stringify(filtered));
                utils.showAlert('Provider removed successfully!', 'success');
                loadProviders();
                loadDashboard();
            }
        }
        
        function deleteReview(reviewId) {
            if (confirm('Are you sure you want to delete this review?')) {
                const reviews = dataManager.getReviews();
                const filtered = reviews.filter(r => r.id !== reviewId);
                localStorage.setItem('reviews', JSON.stringify(filtered));
                utils.showAlert('Review deleted successfully!', 'success');
                loadReviews();
            }
        }
        
        function handleLogout() {
            authManager.logout();
            utils.redirect('index.html');
        }
    </script>
</body>
</html>

